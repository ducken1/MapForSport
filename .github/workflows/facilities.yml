stages:
  - build
  - test
  - deploy

variables:
  MONGO_URI: "mongodb://mongo:27017/facilities"

services:
  - name: mongo:latest
    alias: mongo

build_image:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t my-facility-service .
  artifacts:
    paths:
      - server.log
  only:
    - main

test_service:
  stage: test
  image: docker:latest
  services:
    - docker:dind
    - name: mongo:latest
      alias: mongo
  script:
    # Run your container linked with mongo and wait for readiness
    - docker run -d --name mongo_test mongo:latest
    - docker run -d --name facility_test --link mongo_test:mongo -p 50051:50051 -e MONGO_URI=mongodb://mongo:27017/facilities my-facility-service
    - sleep 10 # wait for server + mongo to be ready
    # Here you could run integration tests calling gRPC endpoints, e.g.:
    # - npm run test
    - docker logs facility_test
  after_script:
    - docker rm -f facility_test mongo_test
  only:
    - main

deploy_service:
  stage: deploy
  image: docker:latest
  script:
    # Deploy your service somewhere (e.g. push to a registry, or ssh deploy)
    - echo "Deploy step - customize as needed"
  only:
    - main
